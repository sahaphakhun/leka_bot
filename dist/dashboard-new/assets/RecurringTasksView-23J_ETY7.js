const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BqkKSn_R.js","assets/index-B8PbDF4y.css"])))=>i.map(i=>d[i]);
import{c as te,m as re,u as ae,r as n,_ as y,t as R,j as e,k as le,B as c,v as S,l as ne,w as L,S as ie,I as ce,e as O,f as q,g as P,h as V,i as o,x as F,C as de,U as oe,y as xe,z as me,s as H,q as z,A as X}from"./index-BqkKSn_R.js";import{S as he}from"./switch-Bjib2JQ2.js";import{P as N}from"./plus-DA9qHoNU.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=te("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);function ye({refreshKey:G=0}){const{groupId:m,canModify:u}=re(),{openRecurringTask:p,openRecurringHistory:W,openConfirmDialog:$}=ae(),[f,v]=n.useState([]),[_,w]=n.useState([]),[M,b]=n.useState(!0),[A,U]=n.useState(null),[E,J]=n.useState(""),[j,K]=n.useState("all"),[C,Q]=n.useState("all");n.useEffect(()=>{D()},[m,G]);const D=async()=>{b(!0),U(null);try{if(!m){v([]),w([]),b(!1);return}const[t,s]=await Promise.all([(async()=>{const{listRecurringTasks:d}=await y(async()=>{const{listRecurringTasks:r}=await import("./index-BqkKSn_R.js").then(i=>i.aX);return{listRecurringTasks:r}},__vite__mapDeps([0,1]));return await d(m)})(),(async()=>{try{const{getGroupMembers:d}=await y(async()=>{const{getGroupMembers:r}=await import("./index-BqkKSn_R.js").then(i=>i.aX);return{getGroupMembers:r}},__vite__mapDeps([0,1]));return await d(m)}catch(d){return console.warn("⚠️ Failed to load members (non-critical):",d),{data:[],members:[]}}})()]),l=Array.isArray(t)?t:Array.isArray(t==null?void 0:t.data)?t.data:Array.isArray(t==null?void 0:t.items)?t.items:[];v(l);const a=Array.isArray(s==null?void 0:s.data)?s.data:Array.isArray(s==null?void 0:s.members)?s.members:Array.isArray(s)?s:[];w(a),console.log("✅ Loaded recurring tasks:",l.length),console.log("✅ Loaded members:",a.length)}catch(t){console.error("❌ Failed to load recurring tasks:",t),U(t.message||"ไม่สามารถโหลดงานประจำได้"),v([]),w([]),R("ไม่สามารถโหลดงานประจำได้",t)}finally{b(!1)}},g=async()=>{await D()},Y=async t=>{if(!u()){H("คุณไม่มีสิทธิ์แก้ไขงานประจำ");return}try{const{toggleRecurringTask:s}=await y(async()=>{const{toggleRecurringTask:l}=await import("./index-BqkKSn_R.js").then(a=>a.aX);return{toggleRecurringTask:l}},__vite__mapDeps([0,1]));await s(m,t.id,!t.isActive),z(t.isActive?"ปิดการใช้งานแล้ว":"เปิดการใช้งานแล้ว"),g()}catch(s){console.error("Failed to toggle recurring task:",s),R("ไม่สามารถเปลี่ยนสถานะได้",s)}},Z=t=>{if(!u()){H("คุณไม่มีสิทธิ์แก้ไขงานประจำ");return}p(t.original||t)},k=t=>{$({title:"ลบงานประจำ",description:`คุณแน่ใจหรือไม่ว่าต้องการลบงานประจำ "${t.title}"? การกระทำนี้ไม่สามารถย้อนกลับได้`,confirmText:"ลบ",cancelText:"ยกเลิก",variant:"destructive",onConfirm:async()=>{try{const{deleteRecurringTask:s}=await y(async()=>{const{deleteRecurringTask:l}=await import("./index-BqkKSn_R.js").then(a=>a.aX);return{deleteRecurringTask:l}},__vite__mapDeps([0,1]));await s(m,t.id),z("ลบงานประจำสำเร็จ"),g()}catch(s){console.error("Failed to delete recurring task:",s),R("ไม่สามารถลบงานประจำได้",s)}}})},ee=t=>{W(t.original||t)},T=n.useMemo(()=>{const t=new Map;return _.forEach(s=>{[s.lineUserId,s.id,s.userId].filter(Boolean).map(a=>a.toString()).forEach(a=>{t.set(a,s),t.set(a.toLowerCase(),s)})}),t},[_]),x=n.useMemo(()=>{const t=s=>{if(!s)return null;const l=T.get(s)||T.get(s.toLowerCase());return l||{lineUserId:s,displayName:s}};return f.map(s=>{const l=Array.isArray(s.assigneeLineUserIds)?s.assigneeLineUserIds:[],a=new Set,d=l.map(r=>t(r)).filter(Boolean).map(r=>({id:r.id||r.userId||r.lineUserId,lineUserId:r.lineUserId||r.id||r.userId,displayName:r.displayName||r.realName||r.name||r.lineUserId})).filter(r=>{const i=r.lineUserId||r.id;if(!i)return!1;const B=i.toLowerCase();return a.has(B)?!1:(a.add(B),!0)});return{id:s.id,title:s.title||s.name||"Untitled",description:s.description||"",recurrence:(s.recurrence||s.frequency||"weekly").toLowerCase(),isActive:!!(s.active??s.isActive??!0),active:!!(s.active??s.isActive??!0),nextRunAt:s.nextRunAt||s.nextRun||s.nextSchedule||s.nextDueTime||null,lastRunAt:s.lastRunAt||s.lastRun||null,totalInstances:s.totalInstances??s.createdCount??s.count??0,assigneeLineUserIds:l,assignedUsers:d,reviewerLineUserId:s.reviewerLineUserId||s.reviewer||null,requireAttachment:!!(s.requireAttachment??s.requiresAttachment??!1),priority:(s.priority||"medium").toLowerCase(),tags:Array.isArray(s.tags)?s.tags:[],weekDay:s.weekDay??s.dayOfWeek??null,dayOfMonth:s.dayOfMonth??s.dateOfMonth??null,timeOfDay:s.timeOfDay||s.initialTime||"09:00",timezone:s.timezone||"Asia/Bangkok",createdAt:s.createdAt||null,updatedAt:s.updatedAt||null,original:s}})},[f,T]),se=t=>({daily:"รายวัน",weekly:"รายสัปดาห์",monthly:"รายเดือน",quarterly:"รายไตรมาส",custom:"กำหนดเอง"})[t]||t,I=x.filter(t=>{const s=(t.title||"").toLowerCase().includes((E||"").toLowerCase()),l=j==="all"||j==="active"&&t.isActive||j==="inactive"&&!t.isActive,a=C==="all"||(t.recurrence||"").toLowerCase()===C.toLowerCase();return s&&l&&a}),h=n.useMemo(()=>{const t=x.length,s=x.filter(r=>r.isActive).length,l=t-s,a=x.reduce((r,i)=>r+(i.totalInstances||0),0),d=x.map(r=>r.nextRunAt).filter(Boolean).map(r=>new Date(r)).sort((r,i)=>r-i)[0];return{total:t,active:s,paused:l,totalInstances:a,nextTask:d}},[f]);return M?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"กำลังโหลด..."})]})}):A?e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx(le,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"ไม่สามารถโหลดงานประจำได้"}),e.jsx("p",{className:"text-gray-600 mb-6",children:A}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(c,{onClick:g,className:"w-full",children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"ลองอีกครั้ง"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"หากปัญหายังคงอยู่ กรุณาติดต่อผู้ดูแลระบบ"})]})]})})}):!M&&!A&&x.length===0?e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"งานประจำ"}),e.jsx("p",{className:"text-muted-foreground",children:"จัดการงานที่ทำซ้ำอัตโนมัติ"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{variant:"outline",onClick:g,children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"รีเฟรช"]}),u()?e.jsxs(c,{onClick:()=>p(null),children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"สร้างงานประจำ"]}):e.jsxs(c,{disabled:!0,variant:"outline",children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"สร้างงานประจำ (ไม่มีสิทธิ์)"]})]})]}),e.jsx("div",{className:"flex items-center justify-center h-96 bg-white rounded-lg border-2 border-dashed border-gray-300",children:e.jsxs("div",{className:"text-center max-w-md px-6",children:[e.jsx(ne,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"ยังไม่มีงานประจำ"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"สร้างงานที่ทำซ้ำอัตโนมัติตามรอบเวลาที่กำหนด เช่น รายวัน รายสัปดาห์ หรือรายเดือน"}),u()?e.jsxs(c,{onClick:()=>p(null),children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"สร้างงานประจำแรก"]}):e.jsx("p",{className:"text-sm text-amber-600",children:"⚠️ คุณไม่มีสิทธิ์สร้างงานประจำ"})]})})]}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"งานประจำ"}),e.jsx("p",{className:"text-muted-foreground",children:"จัดการงานที่ทำซ้ำอัตโนมัติ"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{variant:"outline",onClick:g,children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"รีเฟรช"]}),e.jsxs(c,{onClick:()=>p(null),children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"สร้างงานประจำ"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"rounded-xl border border-blue-100 bg-blue-50 p-5",children:[e.jsx("p",{className:"text-xs text-blue-700",children:"งานประจำทั้งหมด"}),e.jsx("p",{className:"text-3xl font-semibold text-blue-700",children:h.total})]}),e.jsxs("div",{className:"rounded-xl border border-green-100 bg-green-50 p-5",children:[e.jsx("p",{className:"text-xs text-green-700",children:"ใช้งานอยู่"}),e.jsx("p",{className:"text-3xl font-semibold text-green-700",children:h.active})]}),e.jsxs("div",{className:"rounded-xl border border-amber-100 bg-amber-50 p-5",children:[e.jsx("p",{className:"text-xs text-amber-700",children:"หยุดชั่วคราว"}),e.jsx("p",{className:"text-3xl font-semibold text-amber-700",children:h.paused})]}),e.jsxs("div",{className:"rounded-xl border border-purple-100 bg-purple-50 p-5",children:[e.jsx("p",{className:"text-xs text-purple-700",children:"งานที่สร้างสะสม"}),e.jsx("p",{className:"text-3xl font-semibold text-purple-700",children:h.totalInstances}),h.nextTask&&e.jsxs("p",{className:"text-xs text-purple-600 mt-2",children:["งานครั้งถัดไป:"," ",L(h.nextTask,"dd MMM yyyy HH:mm",{locale:X})]})]})]}),e.jsx("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ie,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx(ce,{placeholder:"ค้นหางานประจำ...",value:E,onChange:t=>J(t.target.value),className:"pl-10"})]}),e.jsxs(O,{value:j,onValueChange:K,children:[e.jsx(q,{children:e.jsx(P,{placeholder:"เลือกสถานะ"})}),e.jsxs(V,{children:[e.jsx(o,{value:"all",children:"สถานะ: ทั้งหมด"}),e.jsx(o,{value:"active",children:"ใช้งานอยู่"}),e.jsx(o,{value:"inactive",children:"หยุดใช้งาน"})]})]}),e.jsxs(O,{value:C,onValueChange:Q,children:[e.jsx(q,{children:e.jsx(P,{placeholder:"เลือกรอบเวลา"})}),e.jsxs(V,{children:[e.jsx(o,{value:"all",children:"รอบ: ทั้งหมด"}),e.jsx(o,{value:"daily",children:"รายวัน"}),e.jsx(o,{value:"weekly",children:"รายสัปดาห์"}),e.jsx(o,{value:"monthly",children:"รายเดือน"}),e.jsx(o,{value:"quarterly",children:"รายไตรมาส"}),e.jsx(o,{value:"custom",children:"กำหนดเอง"})]})]})]})}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["แสดง ",I.length," จาก ",x.length," งานประจำ"]}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ชื่องาน"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"รอบการทำซ้ำ"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"สถานะ"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"งานถัดไป"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"จำนวนที่สร้าง"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ผู้รับผิดชอบ"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"การกระทำ"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:I.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"px-6 py-12 text-center text-gray-500",children:"ไม่พบงานประจำ"})}):I.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"font-medium",children:t.title})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(F,{variant:"outline",children:se(t.recurrence)})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{checked:t.isActive,onCheckedChange:()=>Y(t),disabled:!u()}),e.jsx(F,{className:t.isActive?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800",children:t.isActive?"ใช้งานอยู่":"หยุดใช้งาน"})]})}),e.jsx("td",{className:"px-6 py-4",children:t.nextRunAt?e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1 text-gray-900",children:[e.jsx(de,{className:"w-3 h-3"}),L(new Date(t.nextRunAt),"dd MMM yyyy",{locale:X})]}),e.jsx("div",{className:"text-gray-500",children:L(new Date(t.nextRunAt),"HH:mm")})]}):e.jsx("span",{className:"text-gray-400",children:"-"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"text-sm",children:[t.totalInstances," งาน"]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(oe,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"truncate",children:t.assignedUsers&&t.assignedUsers.length>0?t.assignedUsers.map(s=>s.displayName||s.name||s.lineUserId).join(", "):"ไม่ระบุ"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>ee(t),title:"ดูประวัติ",children:e.jsx(ue,{className:"w-4 h-4"})}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>Z(t),title:"แก้ไข",children:e.jsx(xe,{className:"w-4 h-4"})}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>k(t),title:"ลบ",children:e.jsx(me,{className:"w-4 h-4 text-red-600"})})]})})]},t.id))})]})})})]})}export{ye as default};
