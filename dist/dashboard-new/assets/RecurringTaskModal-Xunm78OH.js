const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BqkKSn_R.js","assets/index-B8PbDF4y.css"])))=>i.map(i=>d[i]);
import{m as oe,u as de,r as f,j as s,ah as ue,ai as he,aj as me,ak as ge,al as xe,av as pe,k as fe,ax as je,ab as h,I as S,az as ye,ay as O,B as D,e as R,f as $,g as V,h as k,i as b,O as z,aR as ve,aS as De,C as be,aT as Ne,aU as we,_ as U,s as N,q as H,t as Ae,aV as E,w as Z}from"./index-BqkKSn_R.js";import{L as Te}from"./loader-circle-U84Lk8ZG.js";const Ie="Asia/Bangkok",X=[{value:"weekly",label:"รายสัปดาห์",description:"สร้างงานใหม่เมื่อเลยกำหนดส่งของรอบล่าสุดทุกสัปดาห์",icon:"📅"},{value:"monthly",label:"รายเดือน",description:"สร้างงานใหม่เมื่อเลยกำหนดส่งของรอบล่าสุดทุกเดือน",icon:"📆"},{value:"quarterly",label:"รายไตรมาส",description:"สร้างงานใหม่เมื่อเลยกำหนดส่งของรอบล่าสุดทุก 3 เดือน",icon:"📈"}],j=r=>(r==null?void 0:r.lineUserId)||(r==null?void 0:r.id)||(r==null?void 0:r.userId)||null,_e=r=>{if(!r)return{date:null,time:"23:59"};let d=r instanceof Date?r:new Date(r);return typeof r=="object"&&(r!=null&&r.seconds)&&(d=new Date(r.seconds*1e3)),E(d)?{date:d,time:Z(d,"HH:mm")}:{date:null,time:"23:59"}},Ce=(r,d)=>{if(!r||!E(r))return null;const m=Z(r,"yyyy-MM-dd"),A=d&&d.trim()?d:"23:59";return`${m}T${A}:00`},G=r=>!r||!E(r)?"—":r.toLocaleDateString("th-TH",{year:"numeric",month:"short",day:"numeric"}),W={title:"",description:"",recurrence:"weekly",initialDueDate:null,initialDueTime:"23:59",priority:"medium",requireAttachment:!1,tags:"",assignedUsers:[],reviewer:""},Le=r=>r?Array.isArray(r.assigneeLineUserIds)?r.assigneeLineUserIds.filter(Boolean):Array.isArray(r.assignedUsers)?r.assignedUsers.map(j).filter(Boolean):Array.isArray(r.assignees)?r.assignees.map(j).filter(Boolean):[]:[];function Ee({onTaskCreated:r,onTaskUpdated:d}){const{groupId:m,canModify:A,userId:J,currentUser:p}=oe(),{isRecurringTaskOpen:T,closeRecurringTask:I,selectedRecurring:c}=de(),[F,q]=f.useState(!1),[_,M]=f.useState(!1),[y,K]=f.useState([]),[t,o]=f.useState(W),g=!!(c!=null&&c.id),v=A(),l=!v||_,C=()=>{o({...W})},Q=e=>{var a;if(!e){C();return}const{date:i,time:n}=_e(e.initialDueTime||e.firstDueDate||e.startDate||e.nextRun||e.dueDate);o({title:e.title||e.name||"",description:e.description||"",recurrence:e.recurrence||e.frequency||"weekly",initialDueDate:i,initialDueTime:n||"23:59",priority:e.priority||"medium",requireAttachment:!!(e.requireAttachment??e.requiresAttachment??!1),tags:Array.isArray(e.tags)?e.tags.join(", "):typeof e.tags=="string"?e.tags:"",assignedUsers:Le(e),reviewer:e.reviewerLineUserId||((a=e.reviewer)==null?void 0:a.lineUserId)||e.reviewer||""})},Y=async()=>{if(m)try{const{getGroupMembers:e}=await U(async()=>{const{getGroupMembers:u}=await import("./index-BqkKSn_R.js").then(x=>x.aX);return{getGroupMembers:u}},__vite__mapDeps([0,1])),i=await e(m),n=(i==null?void 0:i.members)||(i==null?void 0:i.data)||(Array.isArray(i)?i:[]),a=Array.isArray(n)?n.filter(u=>j(u)):[];K(a),console.log("✅ Loaded members:",a.length)}catch(e){console.error("❌ Failed to load members:",e),N("ไม่สามารถโหลดรายชื่อสมาชิกได้")}},ee=async e=>{M(!0);try{let i=e;if(e!=null&&e.id&&m)try{const{getRecurringTask:n}=await U(async()=>{const{getRecurringTask:u}=await import("./index-BqkKSn_R.js").then(x=>x.aX);return{getRecurringTask:u}},__vite__mapDeps([0,1])),a=await n(m,e.id);i=(a==null?void 0:a.data)||a||e}catch(n){console.warn("⚠️ Failed to fetch recurring detail:",n)}Q(i)}finally{M(!1)}};f.useEffect(()=>{T&&(Y(),c!=null&&c.id?ee(c):C())},[T,c==null?void 0:c.id,m]);const se=e=>{e&&o(i=>{const n=i.assignedUsers.includes(e);return{...i,assignedUsers:n?i.assignedUsers.filter(a=>a!==e):[...i.assignedUsers,e]}})},ie=()=>{v&&o(e=>({...e,assignedUsers:y.map(i=>j(i)).filter(Boolean)}))},re=()=>{o(e=>({...e,assignedUsers:[]}))},te=f.useMemo(()=>{const e=X.find(x=>x.value===t.recurrence),i=e?e.label:"ที่เลือก",n=G(t.initialDueDate),a=t.initialDueTime||"—",u=a!=="—"?` ${a}`:"";return`เริ่มด้วยกำหนดส่งครั้งแรก: ${n}${u} • เมื่อเลยกำหนดส่ง ระบบจะสร้างงานรอบถัดไปแบบ${i}ทันที`},[t.recurrence,t.initialDueDate,t.initialDueTime]),ae=async e=>{var a;if(e.preventDefault(),!v){N("คุณไม่มีสิทธิ์สร้าง/แก้ไขงานประจำ");return}if(_)return;const i=t.title.trim();if(!i){N("กรุณากรอกชื่องาน");return}if(t.assignedUsers.length===0){N("กรุณาเลือกผู้รับผิดชอบอย่างน้อย 1 คน");return}const n=Ce(t.initialDueDate,t.initialDueTime);if(!n){N("กรุณาเลือกวันครบกำหนดครั้งแรก");return}q(!0);try{const{createRecurringTask:u,updateRecurringTask:x}=await U(async()=>{const{createRecurringTask:L,updateRecurringTask:le}=await import("./index-BqkKSn_R.js").then(ce=>ce.aX);return{createRecurringTask:L,updateRecurringTask:le}},__vite__mapDeps([0,1])),B=J||(p==null?void 0:p.lineUserId)||(p==null?void 0:p.id)||"unknown",w={title:i,description:((a=t.description)==null?void 0:a.trim())||void 0,recurrence:t.recurrence,priority:t.priority||"medium",requireAttachment:!!t.requireAttachment,initialDueTime:n,timezone:Ie,assigneeLineUserIds:t.assignedUsers,createdBy:B,createdByLineUserId:B};t.reviewer&&(w.reviewerLineUserId=t.reviewer);const P=(t.tags||"").split(",").map(L=>L.trim()).filter(Boolean);P.length>0&&(w.tags=P),g&&(c!=null&&c.id)?(await x(m,c.id,w),H("อัปเดตงานประจำสำเร็จ"),d==null||d()):(await u(m,w),H("สร้างงานประจำสำเร็จ"),r==null||r()),C(),I()}catch(u){console.error("❌ Failed to save recurring task:",u),Ae(g?"ไม่สามารถอัปเดตงานประจำได้":"ไม่สามารถสร้างงานประจำได้",u)}finally{q(!1)}},ne=e=>{e||I()};return s.jsx(ue,{open:T,onOpenChange:ne,children:s.jsxs(he,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[s.jsxs(me,{children:[s.jsx(ge,{children:g?"แก้ไขงานประจำ":"สร้างงานประจำใหม่"}),s.jsx(xe,{children:g?"แก้ไขข้อมูลงานประจำแล้วบันทึกเพื่อใช้งานต่อ":"ตั้งค่างานที่จะสร้างซ้ำเมื่อครบกำหนดส่งในครั้งต่อไป"})]}),!v&&s.jsxs(pe,{variant:"warning",className:"bg-amber-50 border-amber-200",children:[s.jsx(fe,{className:"h-4 w-4"}),s.jsxs(je,{className:"text-amber-800",children:["⚠️ ",s.jsx("strong",{children:"โหมดดูอย่างเดียว"})," - คุณไม่มีสิทธิ์",g?"แก้ไข":"สร้าง","งานประจำ",s.jsx("br",{}),"กรุณาเข้าผ่าน LINE ส่วนตัว (ต้องการ userId) เพื่อ",g?"แก้ไข":"สร้าง","งานประจำ"]})]}),_&&v&&s.jsxs("div",{className:"flex items-center gap-2 rounded border border-dashed border-blue-200 bg-blue-50 px-3 py-2 text-sm text-blue-700",children:[s.jsx(Te,{className:"h-4 w-4 animate-spin"}),"กำลังโหลดข้อมูลงานประจำ..."]}),s.jsxs("form",{onSubmit:ae,className:"space-y-5",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(h,{htmlFor:"title",children:"ชื่องาน *"}),s.jsx(S,{id:"title",value:t.title,onChange:e=>o(i=>({...i,title:e.target.value})),placeholder:"ระบุชื่องาน",required:!0,disabled:l})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(h,{htmlFor:"description",children:"รายละเอียด"}),s.jsx(ye,{id:"description",value:t.description,onChange:e=>o(i=>({...i,description:e.target.value})),placeholder:"ระบุรายละเอียด (ไม่บังคับ)",rows:3,disabled:l})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(h,{children:"ผู้รับผิดชอบ *"}),s.jsxs("div",{className:"rounded-lg border p-4 space-y-3",children:[y.length===0?s.jsx("p",{className:"text-sm text-muted-foreground",children:"ไม่พบข้อมูลสมาชิกในกลุ่ม"}):s.jsx("div",{className:"max-h-48 space-y-2 overflow-y-auto pr-1",children:y.map(e=>{const i=j(e);return i?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(O,{id:`assignee-${i}`,checked:t.assignedUsers.includes(i),onCheckedChange:()=>se(i),disabled:l}),s.jsx("label",{htmlFor:`assignee-${i}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:e.displayName||e.realName||e.name||i})]},i):null})}),s.jsxs("div",{className:"flex gap-2 border-t pt-2",children:[s.jsx(D,{type:"button",variant:"outline",size:"sm",onClick:ie,disabled:l||y.length===0,children:"เลือกทั้งหมด"}),s.jsx(D,{type:"button",variant:"outline",size:"sm",onClick:re,disabled:l||t.assignedUsers.length===0,children:"ล้างทั้งหมด"})]})]})]}),s.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(h,{children:"ความสำคัญ"}),s.jsxs(R,{value:t.priority,onValueChange:e=>o(i=>({...i,priority:e})),disabled:l,children:[s.jsx($,{children:s.jsx(V,{})}),s.jsxs(k,{children:[s.jsx(b,{value:"low",children:"ต่ำ"}),s.jsx(b,{value:"medium",children:"ปานกลาง"}),s.jsx(b,{value:"high",children:"สูง"})]})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(h,{children:"ผู้ตรวจงาน"}),s.jsxs(R,{value:t.reviewer||"__none",onValueChange:e=>o(i=>({...i,reviewer:e==="__none"?"":e})),disabled:l,children:[s.jsx($,{children:s.jsx(V,{placeholder:"(ไม่ระบุ)"})}),s.jsxs(k,{children:[s.jsx(b,{value:"__none",children:"(ไม่ระบุ)"}),y.map(e=>{const i=j(e);return i?s.jsx(b,{value:i,children:e.displayName||e.realName||e.name||i},i):null})]})]})]})]}),s.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(h,{htmlFor:"tags",children:"แท็ก (คั่นด้วยจุลภาค)"}),s.jsx(S,{id:"tags",value:t.tags,onChange:e=>o(i=>({...i,tags:e.target.value})),placeholder:"เช่น: รายงาน, ประจำ",disabled:l})]}),s.jsxs("div",{className:"flex items-center gap-2 pt-6",children:[s.jsx(O,{id:"requireAttachment",checked:t.requireAttachment,onCheckedChange:e=>o(i=>({...i,requireAttachment:!!e})),disabled:l}),s.jsx(h,{htmlFor:"requireAttachment",className:"text-sm font-medium leading-none",children:"ต้องแนบไฟล์ทุกครั้ง"})]})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsx(h,{className:"text-lg font-medium text-gray-800",children:"รอบการทำงาน"}),s.jsx("div",{className:"grid gap-3",children:X.map(e=>{const i=t.recurrence===e.value;return s.jsx("button",{type:"button",onClick:()=>o(n=>({...n,recurrence:e.value})),className:z("w-full rounded-lg border p-3 text-left transition",i?"border-blue-500 bg-blue-50":"border-border hover:bg-muted/60",l&&"cursor-not-allowed opacity-60"),disabled:l,children:s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("span",{className:"text-xl",children:e.icon}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium",children:e.label}),s.jsx("div",{className:"text-sm text-muted-foreground",children:e.description})]})]})},e.value)})})]}),s.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(h,{children:"วันครบกำหนดครั้งแรก *"}),s.jsxs(ve,{modal:!1,children:[s.jsx(De,{asChild:!0,children:s.jsxs(D,{type:"button",variant:"outline",className:z("w-full justify-start text-left font-normal",!t.initialDueDate&&"text-muted-foreground"),disabled:l,children:[s.jsx(be,{className:"mr-2 h-4 w-4"}),t.initialDueDate?G(t.initialDueDate):"เลือกวันที่"]})}),s.jsx(Ne,{className:"w-auto p-0",children:s.jsx(we,{mode:"single",selected:t.initialDueDate,onSelect:e=>o(i=>({...i,initialDueDate:e})),initialFocus:!0,disabled:l?()=>!0:void 0})})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(h,{htmlFor:"initialDueTime",children:"เวลาครบกำหนด"}),s.jsx(S,{id:"initialDueTime",type:"time",value:t.initialDueTime,onChange:e=>o(i=>({...i,initialDueTime:e.target.value})),disabled:l})]})]}),s.jsx("div",{className:"rounded-lg bg-blue-50 p-4 text-sm text-blue-700",children:te}),s.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[s.jsx(D,{type:"button",variant:"outline",onClick:I,children:"ยกเลิก"}),s.jsx(D,{type:"submit",disabled:F||l,children:F?"กำลังบันทึก...":g?"บันทึก":"สร้างงานประจำ"})]})]})]})})}export{Ee as default};
