import{c as le,e as ge,r as d,Z as pe,$ as fe,a0 as je,j as e,B as p,k as K,a1 as E,a2 as $,a3 as k,b as Q,I as P,S as F,V as L,Y as O,J as ee,W as se,x as be,d as Ne,U as we,s as f,h as ve,i as ye}from"./index-CkUAMYdr.js";import{C as Se}from"./checkbox-BTZseQt4.js";import{D as Ce,a as Te,b as De,c as Ie,d as Ae,e as Me}from"./dialog-DPTiGGGx.js";import{I as Ee}from"./input-DKGNKTR-.js";import{L as te}from"./label-BJe2V66q.js";import{T as $e}from"./textarea-qDOkATwC.js";import{B as ke}from"./badge-DsmxL3s7.js";import{a as Pe,F as Fe}from"./folder-open-BmY6atsD.js";import{f as Le}from"./format-DqSJChTQ.js";import{t as Oe}from"./th-Mr45T5HM.js";import"./index-BuCVsLOD.js";import"./check-Eaa5JV2K.js";import"./index-CGJYNE2k.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=le("CloudUpload",[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=le("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]),S={pending:{label:"รอดำเนินการ",className:"bg-blue-100 text-blue-800"},scheduled:{label:"รอกำหนดส่ง",className:"bg-blue-100 text-blue-800"},in_progress:{label:"กำลังดำเนินการ",className:"bg-amber-100 text-amber-800"},"in-progress":{label:"กำลังดำเนินการ",className:"bg-amber-100 text-amber-800"},overdue:{label:"เกินกำหนด",className:"bg-red-100 text-red-800"},completed:{label:"เสร็จแล้ว",className:"bg-green-100 text-green-800"},approved:{label:"อนุมัติแล้ว",className:"bg-green-100 text-green-800"},submitted:{label:"ส่งแล้ว",className:"bg-green-100 text-green-800"},reviewed:{label:"ตรวจแล้ว",className:"bg-green-100 text-green-800"},cancelled:{label:"ยกเลิก",className:"bg-gray-100 text-gray-700"}},z={low:{label:"ต่ำ",className:"text-green-600"},medium:{label:"ปานกลาง",className:"text-amber-600"},high:{label:"สูง",className:"text-red-600"},urgent:{label:"ด่วน",className:"text-red-600"}},U=5,_=t=>{if(!t)return"ไม่มีกำหนด";try{return Le(new Date(t),"dd MMM yyyy HH:mm",{locale:Oe})}catch{return t}},Ue=t=>{if(!t)return S.pending;const a=S[t];if(a)return a;const i=t.replace("_","-");return S[i]||S.pending},_e=t=>t&&z[t.toLowerCase()]||z.medium,re=t=>{var a,i,n,o,c;return((i=(a=t.raw)==null?void 0:a.group)==null?void 0:i.name)||((n=t.group)==null?void 0:n.name)||t.groupName||((c=(o=t.raw)==null?void 0:o.group)==null?void 0:c.lineGroupId)||t.groupId||"ไม่ทราบกลุ่ม"},Be=t=>{const a=[];Array.isArray(t.assignedUsers)&&t.assignedUsers.forEach(n=>{a.push(n.displayName||n.realName||n.name||n.lineUserId)}),t.assignee&&a.push(t.assignee.name||t.assignee.displayName||t.assignee.lineUserId);const i=a.filter(Boolean);return i.length>0?Array.from(new Set(i)).join(", "):"ไม่ระบุ"},He=(t,a,i)=>{const n=new FormData;return n.append("userId",t),n.append("comment",a||""),i.forEach(o=>n.append("attachments",o)),n},Re=async(t,a,i,n)=>{const o=await fetch(`/api/dashboard/tasks/${t}/submit`,{method:"POST",body:He(a,i,n)});let c;try{c=await o.json()}catch{c=null}if(!o.ok||!(c!=null&&c.success)){const x=(c==null?void 0:c.error)||(c==null?void 0:c.message)||`HTTP ${o.status}`;throw new Error(x)}return(c==null?void 0:c.data)||null};function as(){const{groupId:t,userId:a,currentUser:i}=ge(),n=!a,[o,c]=d.useState(null),[x,C]=d.useState([]),[j,B]=d.useState(!1),[ne,H]=d.useState(!1),[R,q]=d.useState(null),[T,b]=d.useState(new Set),[ce,D]=d.useState(!1),[G,I]=d.useState(""),[A,N]=d.useState([]),[g,V]=d.useState(!1),[W,M]=d.useState({current:0,total:0}),w=d.useMemo(()=>x.filter(s=>T.has(s.id)),[x,T]),u=w.length,Y=d.useCallback(async()=>{if(a){H(!0);try{const s=await pe(a,t);c(s||null)}catch(s){console.warn("⚠️ ไม่สามารถโหลดข้อมูลผู้ใช้ได้",s)}finally{H(!1)}}},[a,t]),v=d.useCallback(async()=>{if(!a){C([]);return}B(!0),q(null);try{const s=await fe(a,{status:"pending,in_progress,overdue",excludeSubmitted:"true"}),r=je(s||[]);C(r)}catch(s){console.error("❌ โหลดรายการงานไม่สำเร็จ",s),q(s.message||"ไม่สามารถโหลดรายการงานได้"),C([])}finally{B(!1)}},[a]);d.useEffect(()=>{Y()},[Y]),d.useEffect(()=>{v()},[v]);const ie=s=>{b(r=>{const m=new Set(r);return m.has(s)?m.delete(s):m.add(s),m})},de=()=>{if(u===x.length){b(new Set);return}b(new Set(x.map(s=>s.id)))},J=s=>{const r=Array.from(s||[]);r.length!==0&&N(m=>{const l=U-m.length;if(l<=0)return f(`เพิ่มไฟล์ได้สูงสุด ${U} ไฟล์`),m;r.length>l&&f(`เพิ่มได้อีก ${l} ไฟล์เท่านั้น`);const h=r.slice(0,l);return[...m,...h]})},oe=s=>{N(r=>r.filter((m,l)=>l!==s))},me=s=>{var r;s.preventDefault(),s.stopPropagation(),(r=s.dataTransfer)!=null&&r.files&&J(s.dataTransfer.files)},xe=s=>{s.preventDefault(),s.stopPropagation()},ue=()=>{if(n){f("โหมดดูอย่างเดียวไม่สามารถส่งงานได้");return}if(u===0){f("กรุณาเลือกงานที่ต้องการส่งก่อน");return}D(!0)},X=()=>{g||(D(!1),I(""),N([]),M({current:0,total:0}))},he=async()=>{if(!a){f("กรุณาเข้าสู่ระบบผ่านลิงก์ใน LINE ส่วนตัวก่อนส่งงาน");return}V(!0),M({current:0,total:u});const s=[];for(let l=0;l<w.length;l+=1){const h=w[l];try{await Re(h.id,a,G,A),s.push({taskId:h.id,success:!0})}catch(y){console.error(`❌ ส่งงาน ${h.id} ไม่สำเร็จ`,y),s.push({taskId:h.id,success:!1,message:y.message||"ส่งงานไม่สำเร็จ"})}M({current:l+1,total:u})}const r=s.filter(l=>l.success).length,m=s.filter(l=>!l.success);r>0&&ve(`ส่งงานสำเร็จ ${r} รายการ`),m.length>0&&m.forEach(l=>{const h=x.find(y=>y.id===l.taskId);ye(`ส่งงาน "${(h==null?void 0:h.title)||l.taskId}" ไม่สำเร็จ: ${l.message}`)}),r>0&&(b(new Set),I(""),N([]),D(!1),await v()),V(!1)},Z=d.useMemo(()=>({total:x.length,selected:u}),[x.length,u]);return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"ส่งงาน"}),e.jsx("p",{className:"text-muted-foreground",children:"เลือกงานที่ต้องการส่งแล้วแนบไฟล์เพิ่มเติมได้ตามต้องการ"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{variant:"outline",onClick:v,disabled:j,children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),j?"กำลังโหลด...":"รีเฟรช"]}),e.jsxs(p,{onClick:ue,disabled:n||u===0,children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),u>0?`ส่งงาน ${u} รายการ`:"ส่งงาน"]})]})]}),n&&e.jsxs(E,{variant:"warning",children:[e.jsx($,{children:"โหมดดูอย่างเดียว"}),e.jsx(k,{children:"กรุณาเข้าสู่ระบบผ่านลิงก์ใน LINE ส่วนตัวเพื่อส่งงานและแนบไฟล์ได้ครบถ้วน"})]}),R&&e.jsxs(E,{variant:"destructive",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx($,{children:"ไม่สามารถโหลดรายการงานได้"}),e.jsx(k,{children:R})]}),e.jsx(P,{children:e.jsxs(F,{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 text-blue-600",children:e.jsx(ze,{className:"h-6 w-6"})}),e.jsxs("div",{children:[e.jsx(L,{className:"text-lg",children:"ข้อมูลผู้ใช้งาน"}),e.jsx(O,{children:ne?"กำลังโหลดข้อมูล...":(o==null?void 0:o.displayName)||(o==null?void 0:o.name)||(i==null?void 0:i.displayName)||(i==null?void 0:i.name)||a||"ไม่ทราบชื่อ"})]})]}),e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:[e.jsxs("p",{children:["งานที่ต้องส่ง: ",Z.total," รายการ"]}),e.jsxs("p",{children:["เลือกแล้ว: ",Z.selected," รายการ"]})]})]})}),e.jsxs(P,{children:[e.jsxs(F,{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(L,{children:"รายการงานที่ต้องส่ง"}),e.jsx(O,{children:'เลือกงานที่ต้องการส่ง จากนั้นกดปุ่ม "ส่งงาน"'})]}),e.jsx(p,{variant:"outline",size:"sm",onClick:de,disabled:x.length===0||n||j,children:u===x.length?"ยกเลิกการเลือกทั้งหมด":"เลือกทั้งหมด"})]}),e.jsx(ee,{children:j?e.jsxs("div",{className:"py-12 text-center text-muted-foreground",children:[e.jsx(K,{className:"mx-auto mb-3 h-6 w-6 animate-spin"}),"กำลังโหลดรายการงาน..."]}):x.length===0?e.jsxs("div",{className:"py-12 text-center text-muted-foreground",children:[e.jsx(se,{className:"mx-auto mb-3 h-8 w-8 text-green-500"}),"ไม่มีงานที่ต้องส่งในขณะนี้"]}):e.jsx("div",{className:"space-y-3",children:x.map(s=>{const r=Ue(s.status),m=_e(s.priority),l=T.has(s.id);return e.jsx("div",{className:be("rounded-lg border p-4 transition-colors",l?"border-blue-400 bg-blue-50":"border-border bg-white"),children:e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-start md:justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Se,{checked:l,onCheckedChange:()=>ie(s.id),disabled:n,className:"mt-1"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"font-semibold text-base text-foreground",children:s.title||"ไม่ทราบชื่องาน"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(ke,{className:r.className,children:r.label}),e.jsxs("span",{className:m.className,children:["• ความสำคัญ: ",m.label]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ne,{className:"h-3 w-3"}),_(s.dueTime||s.dueDate)]})]})]}),e.jsxs("div",{className:"grid gap-1 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4"}),e.jsx("span",{children:re(s)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx("span",{children:Be(s)})]})]})]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsxs("div",{children:["สร้างเมื่อ: ",_(s.createdAt)]}),s.completedAt&&e.jsxs("div",{children:["ส่งล่าสุด: ",_(s.completedAt)]})]})]})},s.id)})})})]}),e.jsx(Ce,{open:ce,onOpenChange:X,children:e.jsxs(Te,{className:"max-w-2xl",children:[e.jsxs(De,{children:[e.jsx(Ie,{children:"ยืนยันการส่งงาน"}),e.jsx(Ae,{children:"ตรวจสอบสรุปงานและแนบไฟล์เพิ่มเติมก่อนยืนยันการส่ง"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(P,{className:"border-blue-200 bg-blue-50",children:[e.jsxs(F,{className:"pb-2",children:[e.jsxs(L,{className:"text-sm font-semibold text-blue-900",children:["สรุปงานที่เลือก (",u," รายการ)"]}),e.jsx(O,{children:"ระบบจะส่งงานให้ผู้ดูแลเมื่อคุณยืนยัน"})]}),e.jsx(ee,{className:"space-y-2 text-sm",children:w.map(s=>e.jsxs("div",{className:"flex items-center gap-2 text-blue-900",children:[e.jsx(se,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium",children:s.title}),e.jsxs("span",{className:"text-blue-700",children:["(",re(s),")"]})]},`summary-${s.id}`))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"submit-comment",children:"หมายเหตุ (ไม่บังคับ)"}),e.jsx($e,{id:"submit-comment",placeholder:"กรอกหมายเหตุเพิ่มเติมสำหรับผู้ตรวจ",value:G,onChange:s=>I(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(te,{children:["ไฟล์แนบเพิ่มเติม (สูงสุด ",U," ไฟล์)"]}),e.jsxs("div",{className:"flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-border bg-muted/40 px-6 py-8 text-center transition hover:border-blue-300",onDrop:me,onDragOver:xe,children:[e.jsx(ae,{className:"mb-2 h-8 w-8 text-blue-500"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์จากเครื่องของคุณ"}),e.jsx(Ee,{type:"file",multiple:!0,className:"mt-3 w-auto cursor-pointer",onChange:s=>J(s.target.files),accept:".jpg,.jpeg,.png,.gif,.webp,.svg,.pdf,.doc,.docx,.xls,.xlsx,.csv,.ppt,.pptx,.txt,.zip,.rar,.7z,.mp4,.mov,.avi,.mp3,.wav"})]}),A.length>0&&e.jsx("div",{className:"grid gap-2 rounded-lg border bg-white p-3",children:A.map((s,r)=>e.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"truncate max-w-[220px] sm:max-w-[320px]",children:s.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",(s.size/1024/1024).toFixed(2)," MB)"]})]}),e.jsx(p,{variant:"ghost",size:"sm",className:"text-destructive",onClick:()=>oe(r),disabled:g,children:"ลบ"})]},`${s.name}-${r}`))})]}),g&&e.jsxs(E,{children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx($,{children:"กำลังส่งงาน..."}),e.jsx(k,{children:`กำลังส่ง ${W.current} / ${W.total} รายการ`})]})]}),e.jsxs(Me,{className:"gap-2",children:[e.jsx(p,{variant:"outline",onClick:X,disabled:g,children:"ยกเลิก"}),e.jsx(p,{onClick:he,disabled:g,children:g?"กำลังส่ง...":"ยืนยันการส่ง"})]})]})})]})}export{as as default};
