# เพิ่มฟังก์ชันตรวจสอบข้อความ "งาน" ในแชทส่วนตัว

## สรุปการเปลี่ยนแปลง

เพิ่มฟังก์ชันตรวจสอบข้อความ "งาน" ในแชทส่วนตัวของบอท เมื่อผู้ใช้พิมพ์ "งาน" บอทจะตอบการ์ดเดียวแสดงงานทั้งหมดที่ผู้ใช้เป็นผู้รับผิดชอบและสถานะงานยังไม่เสร็จ โดยแบ่งงานตามกลุ่มและใช้ชื่อกลุ่มแทนไอดีกลุ่ม

## ไฟล์ที่แก้ไข

### 1. `src/controllers/webhookController.ts`

#### การเปลี่ยนแปลง:
- แก้ไขฟังก์ชัน `handleMessageEvent()` ให้รองรับแชทส่วนตัว (`source.type === 'user'`)
- เพิ่มฟังก์ชัน `ensureUserExists()` สำหรับสร้าง user record ในแชทส่วนตัว
- เพิ่มฟังก์ชัน `handlePersonalTaskRequest()` เพื่อจัดการคำขอดูงานในแชทส่วนตัว
- เพิ่มฟังก์ชัน `groupTasksByGroup()` เพื่อจัดกลุ่มงานตามกลุ่ม
- เพิ่มฟังก์ชัน `createPersonalTasksFlexMessage()` เพื่อสร้าง Flex Message แสดงงานส่วนตัว
- เพิ่มฟังก์ชัน `getTaskStatusEmoji()` เพื่อแสดง emoji สถานะงาน

#### รายละเอียดการทำงาน:
1. **ตรวจสอบประเภทแชท**: รองรับทั้งแชทกลุ่มและแชทส่วนตัว
2. **ตรวจสอบข้อความ "งาน"**: ในแชทส่วนตัวเท่านั้น
3. **ดึงงานผู้ใช้**: งานที่ผู้ใช้เป็นผู้รับผิดชอบและยังไม่เสร็จ
4. **จัดกลุ่มงาน**: แบ่งงานตามกลุ่มและใช้ชื่อกลุ่ม
5. **สร้างการ์ด**: การ์ดใหญ่แบบเดียวกับสรุปรายวัน

### 2. `src/services/TaskService.ts`

#### การเปลี่ยนแปลง:
- เพิ่มฟังก์ชัน `getUserIncompleteTasks()` เพื่อดึงงานที่ผู้ใช้เป็นผู้รับผิดชอบและยังไม่เสร็จ

#### รายละเอียดการทำงาน:
- ค้นหา user จาก LINE User ID
- ดึงงานที่มีสถานะ: pending, in_progress, overdue, submitted, reviewed
- เรียงลำดับตามกำหนดส่ง

## วิธีใช้งาน

### การทำงานในแชทส่วนตัว:
1. **เปิดแชทส่วนตัวกับบอท**
2. **พิมพ์ข้อความ**: `งาน`
3. **บอทจะตอบกลับ**: การ์ดแสดงงานทั้งหมดที่ต้องทำ

### การทำงานในแชทกลุ่ม:
- ยังคงทำงานเหมือนเดิม
- ไม่มีการเปลี่ยนแปลง

## การออกแบบการ์ด

### ลักษณะการ์ด:
- **ขนาด**: Large (เหมือนการ์ดสรุปรายวัน)
- **หัวข้อ**: "📋 งานที่ต้องทำของคุณ (X รายการ)"
- **เนื้อหา**: แบ่งตามกลุ่มงาน

### โครงสร้างการ์ด:
```
📋 งานที่ต้องทำของคุณ (25 รายการ)

🏷️ ชื่อกลุ่มที่ 1
⏳ ชื่องานที่ 1
⏰ 25/12 14:00
🔄 ชื่องานที่ 2
⏰ 26/12 09:00
📤 ชื่องานที่ 3
⏰ 27/12 16:00
⏳ ชื่องานที่ 4
⏰ 28/12 10:00
🔄 ชื่องานที่ 5
⏰ 29/12 15:00
📤 ชื่องานที่ 6
⏰ 30/12 12:00
⏳ ชื่องานที่ 7
⏰ 31/12 09:00
🔄 ชื่องานที่ 8
⏰ 01/01 14:00
📤 ชื่องานที่ 9
⏰ 02/01 11:00
⏳ ชื่องานที่ 10
⏰ 03/01 16:00
... และอีก 5 งาน

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏷️ ชื่อกลุ่มที่ 2
⏳ ชื่องานที่ 11
⏰ 04/01 10:00
🔄 ชื่องานที่ 12
⏰ 05/01 13:00
📤 ชื่องานที่ 13
⏰ 06/01 15:00
⏳ ชื่องานที่ 14
⏰ 07/01 09:00
🔄 ชื่องานที่ 15
⏰ 08/01 14:00
📤 ชื่องานที่ 16
⏰ 09/01 11:00
⏳ ชื่องานที่ 17
⏰ 10/01 16:00
🔄 ชื่องานที่ 18
⏰ 11/01 12:00
📤 ชื่องานที่ 19
⏰ 12/01 10:00
⏳ ชื่องานที่ 20
⏰ 13/01 15:00
... และอีก 5 งาน

[ดูงานทั้งหมดในเว็บ]
```

### รายละเอียดการแสดงผล:
- **หัวข้อกลุ่ม**: แสดงชื่อกลุ่ม (ไม่ใช้ไอดี) กำกับด้วย 🏷️
- **งานในกลุ่ม**: แสดง 10 งานแรกของแต่ละกลุ่ม
- **สถานะงาน**: แสดง emoji สถานะ
- **กำหนดส่ง**: แสดงวันที่และเวลา
- **จำนวนงานที่เหลือ**: แสดงจำนวนงานที่ไม่ได้แสดง (ถ้ามีมากกว่า 10 งาน)
- **เส้นคั่น**: แยกระหว่างกลุ่ม
- **ปุ่ม**: ลิงก์ไปหน้าเว็บดูงานทั้งหมด

## Emoji สถานะงาน

| สถานะ | Emoji | คำอธิบาย |
|--------|--------|----------|
| pending | ⏳ | รอเริ่มทำ |
| in_progress | 🔄 | กำลังทำ |
| submitted | 📤 | ส่งแล้ว |
| reviewed | 👀 | ตรวจแล้ว |
| default | 📋 | อื่นๆ |

## ความปลอดภัย

1. **การตรวจสอบสิทธิ์**: ตรวจสอบ user ในระบบ
2. **การจัดการข้อผิดพลาด**: มี try-catch เพื่อจัดการข้อผิดพลาด
3. **การล็อก**: บันทึกการทำงานและข้อผิดพลาด
4. **การแจ้งเตือน**: แจ้งเตือนเมื่อเกิดข้อผิดพลาด

## การทดสอบ

- ✅ Build สำเร็จ (npm run build)
- ✅ ไม่มี TypeScript errors
- ✅ ฟังก์ชันทำงานตามที่ออกแบบไว้

## หมายเหตุ

- ฟีเจอร์นี้ทำงานเฉพาะในแชทส่วนตัวเท่านั้น
- ในแชทกลุ่มยังคงทำงานเหมือนเดิม
- การ์ดออกแบบให้เหมือนการ์ดสรุปรายวัน
- ใช้ชื่อกลุ่มแทนไอดีกลุ่มเพื่อความเป็นมิตรกับผู้ใช้
- แสดงงานที่ยังไม่เสร็จเท่านั้น (ไม่รวมงานที่เสร็จแล้ว)
- แสดง 10 งานแรกของแต่ละกลุ่มเพื่อให้เห็นภาพรวมงานทั้งหมด
- แยกหมวดหมู่ด้วยชื่อกลุ่มและแสดงชื่อกลุ่มกำกับหัวข้อด้วย 🏷️
