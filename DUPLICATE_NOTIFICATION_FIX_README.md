# การแก้ไขปัญหาการส่งการแจ้งเตือนงานใหม่ซ้ำ

## ปัญหา
การ์ดการส่งงานใหม่ถูกส่งซ้ำๆ ในกลุ่มหลายครั้ง จนทำให้เกิดการรบกวน โดยควรส่งเพียงครั้งเดียวเมื่อผู้รับผิดชอบกดส่ง และอีกครั้งหากงานถูกตีกลับและส่งใหม่

## สาเหตุ
ระบบไม่มีกลไกป้องกันการส่งการแจ้งเตือนซ้ำสำหรับการส่งงานใหม่ ทำให้เมื่อมีการเรียกใช้ `recordSubmission` หลายครั้ง จะส่งการแจ้งเตือนในกลุ่มทุกครั้ง

## การแก้ไข
เพิ่มกลไกป้องกันการส่งซ้ำใน `NotificationService.ts` โดยใช้ระบบ tracking เหมือนกับที่ใช้ในการแจ้งเตือนอื่นๆ

### ไฟล์ที่แก้ไข: `src/services/NotificationService.ts`

**เมธอด `sendTaskSubmittedNotification`**:
- เพิ่มการตรวจสอบว่าส่งการแจ้งเตือนไปแล้วหรือไม่
- ใช้ `notificationKey = 'task_submitted_${task.id}'` เพื่อติดตาม
- บันทึกการส่งใน `_sentNotifications` Set
- ลบออกหลังจาก 1 ชั่วโมง เพื่อป้องกันการส่งซ้ำ

**การเปลี่ยนแปลง**:
```typescript
// ตรวจสอบว่าส่งการแจ้งเตือนไปแล้วหรือไม่
const notificationKey = `task_submitted_${task.id}`;
if (this._sentNotifications.has(notificationKey)) {
  console.log(`⚠️ Task submitted notification already sent for task: ${task.id}`);
  return;
}

// ... ส่งการแจ้งเตือน ...

// บันทึกว่าส่งการแจ้งเตือนแล้ว
this._sentNotifications.add(notificationKey);

// ลบออกหลังจาก 1 ชั่วโมง (สำหรับการแจ้งเตือนการส่งงาน)
setTimeout(() => {
  this._sentNotifications.delete(notificationKey);
}, 60 * 60 * 1000);
```

## ผลลัพธ์
- ✅ การแจ้งเตือนการส่งงานใหม่จะส่งเพียงครั้งเดียวต่องาน
- ✅ ลดการรบกวนจากการแจ้งเตือนที่ซ้ำซ้อน
- ✅ ยังคงส่งการแจ้งเตือนให้ผู้ตรวจทางส่วนตัว
- ✅ ระบบป้องกันการส่งซ้ำทำงานอัตโนมัติ

## การทำงาน
1. **ครั้งแรก**: เมื่อผู้รับผิดชอบส่งงาน จะส่งการแจ้งเตือนในกลุ่มและให้ผู้ตรวจ
2. **ครั้งต่อมา**: หากมีการเรียกใช้ `recordSubmission` อีก จะไม่ส่งการแจ้งเตือนในกลุ่มซ้ำ
3. **หลังจาก 1 ชั่วโมง**: ระบบจะลบการติดตามออก ทำให้สามารถส่งการแจ้งเตือนใหม่ได้ (กรณีงานถูกตีกลับและส่งใหม่)

## การทดสอบ
รันคำสั่ง `npx tsc --noEmit` เพื่อตรวจสอบว่าไม่มี TypeScript errors

## หมายเหตุ
การเปลี่ยนแปลงนี้จะเริ่มมีผลทันทีหลังจาก deploy ระบบใหม่ และจะป้องกันการส่งการแจ้งเตือนซ้ำในอนาคต
