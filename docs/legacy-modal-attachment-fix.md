# แนวทางแก้ปัญหาไฟล์แนบไม่แสดงในโมดัลงาน (แดชบอร์ดเวอร์ชันเก่า)

## สาเหตุหลัก
- โค้ดชุดล่าสุดเพิ่มฟังก์ชัน `refreshLegacyTaskDetails` เพื่อดึงข้อมูลงานฉบับเต็มมารวมกับโมดัลเดิม แต่ปลายทางที่เรียกใช้คือ `/api/task/:taskId` (รูปแบบเอกพจน์) ซึ่งไม่มีอยู่จริงในเซิร์ฟเวอร์ ทำให้คำขอถูกตอบกลับเป็น 404 และไม่ได้รับข้อมูลไฟล์แนบกลับมา.
- เมื่อไม่มีข้อมูลไฟล์จาก API โค้ดฝั่งไคลเอนต์จึงเรนเดอร์ข้อความ "ไม่มีไฟล์แนบ" ทิ้งไว้ ทำให้ผู้ใช้เห็นโมดัลว่าง ทั้งที่งานมีไฟล์อยู่จริง (ตรวจสอบได้จากการเปิดในแชท LINE ซึ่งใช้ endpoint ที่ถูกต้อง).

## สิ่งที่ต้องแก้ไข
1. **แก้ปลายทาง API ให้ถูกต้อง**
   - ในไฟล์ `dashboard/script-vanilla.js` ส่วนของฟังก์ชัน `refreshLegacyTaskDetails` ให้เปลี่ยน URL จาก `/api/task/${taskId}` เป็น `/api/tasks/${taskId}` เพื่อให้ตรงกับเส้นทางที่ประกาศไว้ในฝั่งเซิร์ฟเวอร์.
   - ถ้าใช้การระบุ `userId` ในคำขอ (ตัวอย่างเช่นจุดอื่นของไฟล์ใช้ `?userId=${encodeURIComponent(this.currentUserId || '')}`) ควรเพิ่มพารามิเตอร์นี้ไปพร้อมกันเพื่อให้แน่ใจว่า API คืนข้อมูลส่วนที่ต้องการทั้งหมด รวมทั้งไฟล์แนบ.

2. **รวมข้อมูลไฟล์จากการตอบกลับ**
   - เมื่อได้รับผลลัพธ์จาก `/api/tasks/:taskId` แล้ว ให้เช็กทั้ง `response.data.attachedFiles` และ `response.data.files` แล้วรวมไว้ใน `mergedTask.attachedFiles` ก่อนส่งเข้า `populateTaskDetailsModal`.
   - กรณีที่ API ส่งเฉพาะ `attachedFiles` อยู่แล้ว ไม่จำเป็นต้องทำอะไรเพิ่ม แต่ถ้าไฟล์อยู่ใน `files` ให้ก๊อปปี้มาเก็บใน `attachedFiles` เพื่อให้ฟังก์ชันเรนเดอร์ไฟล์ (ทั้ง `renderTaskAttachmentSummary` และ `loadTaskFilesComprehensive`) ทำงานต่อได้ทันที.

3. **ตรวจสอบการเรียกซ้ำ**
   - หลังจากแก้ endpoint ให้ถูกต้อง ทดสอบเปิดงาน 2-3 งานติด ๆ กัน เพื่อยืนยันว่าโค้ดตรวจสอบ token (`this.legacyTaskDetailRequestToken`) ยังกันไม่ให้คำตอบเก่าเขียนทับคำตอบใหม่ หากพบว่า modal กระพริบหรือย้อนกลับไปเป็นสถานะก่อนหน้าให้เพิ่มเงื่อนไขเทียบ `taskId` เหมือนที่มีอยู่แล้ว.

## วิธีทดสอบหลังแก้ไข
1. เปิดแดชบอร์ด เลือกงานที่มีไฟล์แนบจากหน้าเว็บ.
2. เปิดเครื่องมือ DevTools → Network แล้วคลิกงานนั้นเพื่อเปิดโมดัล.
3. ยืนยันว่ามีคำขอไปที่ `/api/tasks/<taskId>` และได้สถานะ 200 พร้อมข้อมูลไฟล์ใน response.
4. ตรวจสอบว่าในโมดัลแสดงรายการไฟล์ในส่วน "ไฟล์แนบ" และสรุปไฟล์ด้านบนอย่างถูกต้อง.
5. ทดสอบกับงานที่ไม่มีไฟล์แนบเพื่อให้แน่ใจว่ายังแสดงข้อความว่างถูกต้อง.

> หมายเหตุ: หากกลุ่มของงานไม่ถูกตั้งค่า (`groupId` เป็น `null`) ยังสามารถใช้ข้อมูลไฟล์จากการตอบกลับของ `/api/tasks/:taskId` ได้โดยไม่ต้องเรียก `/api/groups/:groupId/tasks/:taskId/files` เพิ่มเติม.
