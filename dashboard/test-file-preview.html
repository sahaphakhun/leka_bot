<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Modal ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏ü‡∏•‡πå</title>
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .test-container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .file-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 16px; 
            margin-top: 20px; 
        }
        .file-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .file-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        .file-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            color: #6b7280;
        }
        .file-icon.image { color: #10b981; }
        .file-icon.pdf { color: #ef4444; }
        .file-icon.video { color: #8b5cf6; }
        .file-icon.audio { color: #f59e0b; }
        .file-icon.text { color: #06b6d4; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Modal ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏ü‡∏•‡πå</h1>
        <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á modal ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>
        
        <div class="file-grid">
            <!-- ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
            <div class="file-item" onclick="testPreview('image')">
                <div class="file-icon image">
                    <i class="fas fa-image"></i>
                </div>
                <h3>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
                <p>test-image.png</p>
                <small>512 KB</small>
            </div>
            
            <!-- ‡πÑ‡∏ü‡∏•‡πå PDF -->
            <div class="file-item" onclick="testPreview('pdf')">
                <div class="file-icon pdf">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <h3>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF</h3>
                <p>document.pdf</p>
                <small>2.1 MB</small>
            </div>
            
            <!-- ‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ -->
            <div class="file-item" onclick="testPreview('video')">
                <div class="file-icon video">
                    <i class="fas fa-video"></i>
                </div>
                <h3>‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</h3>
                <p>sample-video.mp4</p>
                <small>15.3 MB</small>
            </div>
            
            <!-- ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á -->
            <div class="file-item" onclick="testPreview('audio')">
                <div class="file-icon audio">
                    <i class="fas fa-music"></i>
                </div>
                <h3>‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h3>
                <p>audio-track.mp3</p>
                <small>4.7 MB</small>
            </div>
            
            <!-- ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° -->
            <div class="file-item" onclick="testPreview('text')">
                <div class="file-icon text">
                    <i class="fas fa-file-alt"></i>
                </div>
                <h3>‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
                <p>readme.txt</p>
                <small>8 KB</small>
            </div>
            
            <!-- ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ -->
            <div class="file-item" onclick="testPreview('other')">
                <div class="file-icon">
                    <i class="fas fa-file"></i>
                </div>
                <h3>‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</h3>
                <p>data.xlsx</p>
                <small>156 KB</small>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="modal hidden">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; width: auto; height: auto;">
            <div class="modal-header">
                <h3 id="filePreviewTitle">‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå</h3>
                <button class="modal-close" id="filePreviewModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 0; position: relative; min-height: 400px;">
                <!-- Loading indicator -->
                <div id="filePreviewLoading" class="text-center py-8" style="display: none;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...</p>
                </div>
                
                <!-- File content container -->
                <div id="filePreviewContent" style="width: 100%; height: 100%; min-height: 400px;">
                    <!-- Content will be loaded here -->
                </div>
                
                <!-- Download button -->
                <div class="absolute bottom-4 right-4" style="z-index: 10;">
                    <button id="downloadFileBtn" class="btn btn-primary btn-sm">
                        <i class="fas fa-download mr-2"></i>
                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="modalOverlay" class="modal-overlay hidden"></div>

    <!-- Mock DashboardApp for testing -->
    <script>
        // Mock ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        const mockFiles = {
            image: {
                id: 'test-image',
                originalName: 'test-image.png',
                mimeType: 'image/png',
                size: 524288,
                path: 'data:image/svg+xml;base64,' + btoa('<svg width="600" height="400" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#10b981"/><text x="50%" y="50%" font-family="Arial" font-size="24" fill="white" text-anchor="middle" dy=".3em">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</text></svg>')
            },
            pdf: {
                id: 'test-pdf',
                originalName: 'document.pdf',
                mimeType: 'application/pdf',
                size: 2097152,
                path: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
            },
            video: {
                id: 'test-video',
                originalName: 'sample-video.mp4',
                mimeType: 'video/mp4',
                size: 16777216,
                path: 'https://www.w3schools.com/html/mov_bbb.mp4'
            },
            audio: {
                id: 'test-audio',
                originalName: 'audio-track.mp3',
                mimeType: 'audio/mpeg',
                size: 4932198,
                path: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav'
            },
            text: {
                id: 'test-text',
                originalName: 'readme.txt',
                mimeType: 'text/plain',
                size: 8192
            },
            other: {
                id: 'test-other',
                originalName: 'data.xlsx',
                mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                size: 159744
            }
        };

        // Mock DashboardApp class
        class MockDashboardApp {
            constructor() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('filePreviewModalClose')?.addEventListener('click', () => this.closeModal('filePreviewModal'));
                document.getElementById('modalOverlay')?.addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        this.closeAllModals();
                    }
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });
            }

            openModal(modalId) {
                const modal = document.getElementById(modalId);
                const overlay = document.getElementById('modalOverlay');
                
                if (modal && overlay) {
                    this.closeAllModals();
                    modal.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                }
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                const overlay = document.getElementById('modalOverlay');
                
                if (modal) {
                    modal.classList.add('hidden');
                }
                
                const openModals = document.querySelectorAll('.modal:not(.hidden)');
                if (overlay && openModals.length === 0) {
                    overlay.classList.add('hidden');
                }
            }

            closeAllModals() {
                const modals = document.querySelectorAll('.modal');
                const overlay = document.getElementById('modalOverlay');
                
                modals.forEach(modal => {
                    modal.classList.add('hidden');
                });
                
                if (overlay) {
                    overlay.classList.add('hidden');
                }
            }

            openFilePreviewModal(file) {
                const modal = document.getElementById('filePreviewModal');
                const title = document.getElementById('filePreviewTitle');
                const loading = document.getElementById('filePreviewLoading');
                const content = document.getElementById('filePreviewContent');
                const downloadBtn = document.getElementById('downloadFileBtn');
                
                if (!modal || !title || !loading || !content) {
                    console.error('File preview modal elements not found');
                    return;
                }

                title.textContent = file.originalName || file.name || '‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå';
                content.innerHTML = '';
                loading.style.display = 'block';
                
                if (downloadBtn) {
                    downloadBtn.onclick = () => this.downloadFile(file.id);
                }

                this.openModal('filePreviewModal');
                
                setTimeout(() => {
                    this.loadFilePreview(file);
                }, 100);
            }

            loadFilePreview(file) {
                const loading = document.getElementById('filePreviewLoading');
                const content = document.getElementById('filePreviewContent');
                
                if (!content) return;

                const mimeType = file.mimeType || this.getMimeTypeFromName(file.originalName || file.name);
                let fileContent = '';

                try {
                    if (mimeType.startsWith('image/')) {
                        const imageUrl = this.getFilePreviewUrl(file);
                        fileContent = `
                          <div class="flex items-center justify-center" style="min-height: 400px; background: #f8f9fa;">
                            <img src="${imageUrl}" alt="${this.escapeHtml(file.originalName || file.name)}" 
                                 style="max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" 
                                 onerror="this.parentElement.innerHTML='<div class=\\'text-center py-8\\'><i class=\\'fas fa-image text-4xl text-gray-400 mb-4\\'></i><p class=\\'text-gray-600\\'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</p></div>'">
                          </div>
                        `;
                    } else if (mimeType === 'application/pdf') {
                        const pdfUrl = this.getFilePreviewUrl(file);
                        fileContent = `
                          <div style="width: 100%; height: 80vh; min-height: 500px;">
                            <iframe src="${pdfUrl}" 
                                    style="width: 100%; height: 100%; border: none; border-radius: 8px;" 
                                    title="PDF Viewer"
                                    onload="console.log('PDF loaded successfully')" 
                                    onerror="this.parentElement.innerHTML='<div class=\\'text-center py-8\\'><i class=\\'fas fa-file-pdf text-4xl text-red-400 mb-4\\'></i><p class=\\'text-gray-600\\'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á PDF ‡πÑ‡∏î‡πâ</p><a href=\\\"${pdfUrl}\\\" target=\\\"_blank\\\" class=\\\"btn btn-primary mt-4\\\"><i class=\\\"fas fa-external-link-alt mr-2\\\"></i>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà</a></div>'">
                            </iframe>
                          </div>
                        `;
                    } else if (mimeType.startsWith('video/')) {
                        const videoUrl = this.getFilePreviewUrl(file);
                        fileContent = `
                          <div class="flex items-center justify-center" style="min-height: 400px; background: #f8f9fa;">
                            <video controls style="max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                              <source src="${videoUrl}" type="${mimeType}">
                              ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
                            </video>
                          </div>
                        `;
                    } else if (mimeType.startsWith('audio/')) {
                        const audioUrl = this.getFilePreviewUrl(file);
                        fileContent = `
                          <div class="text-center py-12" style="background: #f8f9fa; min-height: 400px; display: flex; flex-direction: column; justify-content: center;">
                            <i class="fas fa-music text-6xl text-blue-500 mb-6"></i>
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">${this.escapeHtml(file.originalName || file.name)}</h3>
                            <div class="max-w-md mx-auto">
                              <audio controls style="width: 100%;" class="mb-4">
                                <source src="${audioUrl}" type="${mimeType}">
                                ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                              </audio>
                              <p class="text-sm text-gray-600">‡∏Ç‡∏ô‡∏≤‡∏î: ${this.formatFileSize(file.size || 0)}</p>
                            </div>
                          </div>
                        `;
                    } else {
                        const icon = this.getFileIcon(file.originalName || file.name);
                        fileContent = `
                          <div class="text-center py-12" style="background: #f8f9fa; min-height: 400px; display: flex; flex-direction: column; justify-content: center;">
                            <i class="${icon} text-6xl text-gray-400 mb-6"></i>
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">${this.escapeHtml(file.originalName || file.name)}</h3>
                            <p class="text-gray-600 mb-2">‡∏Ç‡∏ô‡∏≤‡∏î: ${this.formatFileSize(file.size || 0)}</p>
                            <p class="text-gray-600 mb-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${mimeType}</p>
                            <p class="text-sm text-gray-500 mb-4">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ</p>
                            <button class="btn btn-primary" onclick="alert('‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö')">
                              <i class="fas fa-download mr-2"></i>
                              ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π
                            </button>
                          </div>
                        `;
                    }
                    
                    content.innerHTML = fileContent;
                    
                } catch (error) {
                    console.error('Error loading file preview:', error);
                    content.innerHTML = `
                      <div class="text-center py-12" style="background: #f8f9fa; min-height: 400px; display: flex; flex-direction: column; justify-content: center;">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-6"></i>
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                        <p class="text-gray-600 mb-4">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ</p>
                        <button class="btn btn-primary" onclick="alert('‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö')">
                          <i class="fas fa-download mr-2"></i>
                          ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ó‡∏ô
                        </button>
                      </div>
                    `;
                } finally {
                    if (loading) {
                        loading.style.display = 'none';
                    }
                }
            }

            getFilePreviewUrl(file) {
                return file.path || '#';
            }

            getMimeTypeFromName(fileName) {
                if (!fileName) return 'application/octet-stream';
                
                const ext = fileName.toLowerCase().split('.').pop();
                const mimeTypes = {
                    'jpg': 'image/jpeg', 'jpeg': 'image/jpeg', 'png': 'image/png', 'gif': 'image/gif', 
                    'pdf': 'application/pdf', 'txt': 'text/plain', 'mp4': 'video/mp4', 'mp3': 'audio/mpeg',
                    'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                };
                
                return mimeTypes[ext] || 'application/octet-stream';
            }

            getFileIcon(fileName) {
                if (!fileName) return 'fas fa-file';
                
                const ext = fileName.toLowerCase().split('.').pop();
                const iconMap = {
                    'jpg': 'fas fa-image', 'jpeg': 'fas fa-image', 'png': 'fas fa-image', 'gif': 'fas fa-image',
                    'pdf': 'fas fa-file-pdf', 'txt': 'fas fa-file-alt', 'mp4': 'fas fa-video', 'mp3': 'fas fa-music',
                    'xlsx': 'fas fa-file-excel', 'xls': 'fas fa-file-excel'
                };
                
                return iconMap[ext] || 'fas fa-file';
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }

            downloadFile(fileId) {
                alert(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ID: ${fileId} (‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö)`);
            }
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á instance
        const dashboardApp = new MockDashboardApp();
        window.dashboardApp = dashboardApp;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        function testPreview(fileType) {
            const file = mockFiles[fileType];
            if (file) {
                dashboardApp.openFilePreviewModal(file);
            }
        }
    </script>
</body>
</html>