<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ทดสอบระบบการจัดการสิทธิ์ - เลขาบอท</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .permission-test-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
        }
        .permission-granted { border-color: #10b981; background-color: #f0fdf4; }
        .permission-denied { border-color: #ef4444; background-color: #fef2f2; }
        .scenario-title { font-weight: bold; margin-bottom: 8px; }
        .test-result { margin-top: 8px; font-size: 14px; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">ทดสอบระบบการจัดการสิทธิ์</h1>
        
        <div class="max-w-4xl mx-auto">
            <!-- Test Controls -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ตั้งค่าการทดสอบ</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">ผู้ใช้ปัจจุบัน (User ID)</label>
                        <select id="currentUserId" class="w-full p-2 border rounded">
                            <option value="">ไม่มี User ID (โหมดดูอย่างเดียว)</option>
                            <option value="user1">user1 (ผู้สร้างงาน)</option>
                            <option value="user2">user2 (ผู้รับผิดชอบงาน)</option>
                            <option value="user3">user3 (ผู้ตรวจงาน)</option>
                            <option value="user4">user4 (ไม่เกี่ยวข้องกับงาน)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">สถานะงาน</label>
                        <select id="taskStatus" class="w-full p-2 border rounded">
                            <option value="pending">รอดำเนินการ (pending)</option>
                            <option value="in_progress">กำลังดำเนินการ (in_progress)</option>
                            <option value="submitted">ส่งแล้ว (submitted)</option>
                            <option value="reviewed">ตรวจแล้ว (reviewed)</option>
                            <option value="completed">เสร็จแล้ว (completed)</option>
                            <option value="overdue">เกินกำหนด (overdue)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">ผู้ตรวจงาน</label>
                        <select id="reviewerUserId" class="w-full p-2 border rounded">
                            <option value="">ไม่มีผู้ตรวจงาน</option>
                            <option value="user3">user3 (ผู้ตรวจงาน)</option>
                            <option value="user1">user1 (ผู้สร้างงาน)</option>
                        </select>
                    </div>
                </div>
                <button id="runTest" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    <i class="fas fa-play mr-2"></i>รันการทดสอบ
                </button>
            </div>

            <!-- Test Results -->
            <div id="testResults" class="space-y-4">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Mock task data generator
        function createMockTask(status, reviewerUserId) {
            return {
                id: 'test-task-1',
                title: 'งานทดสอบระบบสิทธิ์',
                status: status,
                createdBy: 'user1',
                createdByUser: { id: 'user1', lineUserId: 'user1', displayName: 'ผู้สร้างงาน' },
                reviewerUserId: reviewerUserId,
                assignedUsers: [
                    { id: 'user2', lineUserId: 'user2', displayName: 'ผู้รับผิดชอบงาน' }
                ],
                workflow: {
                    review: {
                        reviewerUserId: reviewerUserId
                    }
                }
            };
        }

        // Permission checking functions (copied from dashboard)
        function isUserAssignee(task, currentUserId) {
            if (!currentUserId || !task?.assignedUsers) return false;
            return task.assignedUsers.some(user => 
                user.id === currentUserId || user.lineUserId === currentUserId
            );
        }

        function isUserCreator(task, currentUserId) {
            if (!currentUserId || !task) return false;
            return task.createdBy === currentUserId || 
                   task.createdByUser?.id === currentUserId ||
                   task.createdByUser?.lineUserId === currentUserId;
        }

        function isUserReviewer(task, currentUserId) {
            if (!currentUserId || !task) return false;
            const reviewerUserId = task.reviewerUserId || task.workflow?.review?.reviewerUserId;
            return reviewerUserId === currentUserId;
        }

        function canSubmitTask(task, currentUserId) {
            if (!task) return false;
            const validStatuses = ['pending', 'in_progress', 'overdue'];
            const isValidStatus = validStatuses.includes(task.status);
            const isAssignee = isUserAssignee(task, currentUserId);
            return isValidStatus && isAssignee;
        }

        function canEditTask(task, currentUserId) {
            if (!task) return false;
            if (!currentUserId) return false;
            const isCreator = isUserCreator(task, currentUserId);
            const isReviewer = isUserReviewer(task, currentUserId);
            return isCreator || isReviewer;
        }

        function canDeleteTask(task, currentUserId) {
            if (!task) return false;
            if (!currentUserId) return false;
            return isUserCreator(task, currentUserId);
        }

        function canApproveTask(task, currentUserId) {
            if (!task) return false;
            if (!currentUserId) return false;
            const validStatuses = ['submitted', 'reviewed'];
            if (!validStatuses.includes(task.status)) return false;
            const isReviewer = isUserReviewer(task, currentUserId);
            const isCreatorWithNoReviewer = !task.reviewerUserId && isUserCreator(task, currentUserId);
            return isReviewer || isCreatorWithNoReviewer;
        }

        // Test scenarios
        function runPermissionTests() {
            const currentUserId = document.getElementById('currentUserId').value;
            const taskStatus = document.getElementById('taskStatus').value;
            const reviewerUserId = document.getElementById('reviewerUserId').value || null;
            
            const task = createMockTask(taskStatus, reviewerUserId);
            
            const testResults = [
                {
                    name: 'ส่งงาน (Submit)',
                    result: canSubmitTask(task, currentUserId),
                    expected: getExpectedSubmitPermission(currentUserId, taskStatus),
                    description: 'ผู้รับผิดชอบงานสามารถส่งงานได้เมื่อสถานะเป็น pending, in_progress, overdue'
                },
                {
                    name: 'แก้ไขงาน (Edit)',
                    result: canEditTask(task, currentUserId),
                    expected: getExpectedEditPermission(currentUserId, reviewerUserId),
                    description: 'ผู้สร้างงานและผู้ตรวจงานสามารถแก้ไขงานได้'
                },
                {
                    name: 'ลบงาน (Delete)',
                    result: canDeleteTask(task, currentUserId),
                    expected: getExpectedDeletePermission(currentUserId),
                    description: 'เฉพาะผู้สร้างงานเท่านั้นที่สามารถลบงานได้'
                },
                {
                    name: 'อนุมัติงาน (Approve)',
                    result: canApproveTask(task, currentUserId),
                    expected: getExpectedApprovePermission(currentUserId, taskStatus, reviewerUserId),
                    description: 'ผู้ตรวจงานสามารถอนุมัติงานได้เมื่อสถานะเป็น submitted/reviewed หรือผู้สร้างงานเมื่อไม่มีผู้ตรวจงาน'
                }
            ];
            
            displayTestResults(testResults, currentUserId, task);
        }

        function getExpectedSubmitPermission(userId, status) {
            return userId === 'user2' && ['pending', 'in_progress', 'overdue'].includes(status);
        }

        function getExpectedEditPermission(userId, reviewerUserId) {
            return userId === 'user1' || userId === reviewerUserId;
        }

        function getExpectedDeletePermission(userId) {
            return userId === 'user1';
        }

        function getExpectedApprovePermission(userId, status, reviewerUserId) {
            if (!['submitted', 'reviewed'].includes(status)) return false;
            if (reviewerUserId) {
                return userId === reviewerUserId;
            } else {
                return userId === 'user1'; // ผู้สร้างงานเมื่อไม่มีผู้ตรวจงาน
            }
        }

        function displayTestResults(testResults, currentUserId, task) {
            const container = document.getElementById('testResults');
            
            // User info
            const userInfo = getUserInfo(currentUserId);
            
            let html = `
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">ผลการทดสอบ</h3>
                    <div class="mb-4 p-3 bg-gray-50 rounded">
                        <p><strong>ผู้ใช้ปัจจุบัน:</strong> ${userInfo}</p>
                        <p><strong>สถานะงาน:</strong> ${getStatusText(task.status)}</p>
                        <p><strong>ผู้ตรวจงาน:</strong> ${task.reviewerUserId || 'ไม่มี'}</p>
                    </div>
                    <div class="space-y-3">
            `;
            
            testResults.forEach(test => {
                const isCorrect = test.result === test.expected;
                const cardClass = isCorrect ? 'permission-granted' : 'permission-denied';
                const statusIcon = isCorrect ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-600';
                const statusText = isCorrect ? 'ผ่าน' : 'ไม่ผ่าน';
                
                html += `
                    <div class="permission-test-card ${cardClass}">
                        <div class="scenario-title">
                            <i class="fas ${statusIcon} mr-2"></i>
                            ${test.name} - ${statusText}
                        </div>
                        <div class="text-sm text-gray-600 mb-2">${test.description}</div>
                        <div class="test-result">
                            <strong>ผลที่ได้:</strong> ${test.result ? 'อนุญาต' : 'ไม่อนุญาต'} | 
                            <strong>ผลที่คาดหวัง:</strong> ${test.expected ? 'อนุญาต' : 'ไม่อนุญาต'}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        function getUserInfo(userId) {
            const userMap = {
                '': 'ไม่มี User ID (โหมดดูอย่างเดียว)',
                'user1': 'user1 (ผู้สร้างงาน)',
                'user2': 'user2 (ผู้รับผิดชอบงาน)', 
                'user3': 'user3 (ผู้ตรวจงาน)',
                'user4': 'user4 (ไม่เกี่ยวข้องกับงาน)'
            };
            return userMap[userId] || userId;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'รอดำเนินการ',
                'in_progress': 'กำลังดำเนินการ',
                'submitted': 'ส่งแล้ว',
                'reviewed': 'ตรวจแล้ว',
                'completed': 'เสร็จแล้ว',
                'overdue': 'เกินกำหนด'
            };
            return statusMap[status] || status;
        }

        // Event listeners
        document.getElementById('runTest').addEventListener('click', runPermissionTests);

        // Run initial test
        runPermissionTests();
    </script>
</body>
</html>