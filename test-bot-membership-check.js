#!/usr/bin/env node

/**
 * р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Ыр╣Зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Вр╕нр╕З Bot р╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б
 * р╣Гр╕Кр╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Чр╕Фр╕кр╕нр╕Ър╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╣Гр╕лр╕бр╣Ир╕Чр╕╡р╣Ир╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Вр╣Йр╕▓р╕бр╕▓
 */

const { TaskService } = require('./dist/services/TaskService');
const { LineService } = require('./dist/services/LineService');

async function testBotMembershipCheck() {
  console.log('ЁЯдЦ р╣Ар╕гр╕┤р╣Ир╕бр╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Ыр╣Зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Вр╕нр╕З Bot р╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б...\n');

  try {
    // р╕кр╕гр╣Йр╕▓р╕З instance р╕Вр╕нр╕З services
    const taskService = new TaskService();
    const lineService = new LineService();

    // р╕Чр╕Фр╕кр╕нр╕Ъ LINE Bot connection
    console.log('1я╕ПтГг р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н LINE Bot...');
    try {
      await lineService.initialize();
      console.log('тЬЕ LINE Bot connection р╕кр╕│р╣Ар╕гр╣Зр╕И\n');
    } catch (error) {
      console.log('тЭМ LINE Bot connection р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з:', error.message);
      console.log('тЪая╕П  р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ LINE_CHANNEL_ACCESS_TOKEN р╣Бр╕ер╕░ LINE_CHANNEL_SECRET\n');
      return;
    }

    // р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З Group ID р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Чр╕Фр╕кр╕нр╕Ъ (р╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╣Зр╕Щ Group ID р╕Ир╕гр╕┤р╕З)
    const testGroupId = process.env.TEST_GROUP_ID || 'C5d6c442ec0b3287f71787fdd9437e520';
    
    console.log(`2я╕ПтГг р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Ыр╣Зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Вр╕нр╕З Bot р╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б: ${testGroupId}`);
    try {
      const isBotInGroup = await taskService.checkBotMembershipInGroup(testGroupId);
      console.log(`тЬЕ р╕Ьр╕ер╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ: Bot ${isBotInGroup ? 'р╕вр╕▒р╕Зр╕нр╕вр╕╣р╣Ир╣Гр╕Щ' : 'р╣Др╕бр╣Ир╕нр╕вр╕╣р╣Ир╣Гр╕Щ'} р╕Бр╕ер╕╕р╣Ир╕б`);
    } catch (error) {
      console.log('тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Ыр╣Зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╣Др╕Фр╣Й:', error.message);
    }

    console.log('\n3я╕ПтГг р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Фр╕╢р╕Зр╕Зр╕▓р╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б...');
    try {
      const { tasks } = await taskService.getGroupTasks(testGroupId);
      console.log(`тЬЕ р╕Юр╕Ър╕Зр╕▓р╕Щ ${tasks.length} р╕гр╕▓р╕вр╕Бр╕▓р╕гр╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б`);
      if (tasks.length > 0) {
        tasks.slice(0, 3).forEach((task, index) => {
          console.log(`   ${index + 1}. ${task.title} (${task.status})`);
        });
        if (tasks.length > 3) {
          console.log(`   ... р╣Бр╕ер╕░р╕нр╕╡р╕Б ${tasks.length - 3} р╕гр╕▓р╕вр╕Бр╕▓р╕г`);
        }
      }
    } catch (error) {
      console.log('тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Фр╕╢р╕Зр╕Зр╕▓р╕Щр╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕бр╣Др╕Фр╣Й:', error.message);
    }

    console.log('\n4я╕ПтГг р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕ер╕Ър╕Зр╕▓р╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б (р╕Ир╕│р╕ер╕нр╕З)...');
    try {
      // р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕: р╣Др╕бр╣Ир╕Др╕зр╕гр╕гр╕▒р╕Щр╕Бр╕▓р╕гр╕ер╕Ър╕Ир╕гр╕┤р╕Зр╣Гр╕Щр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ
      console.log('тЪая╕П  р╕Вр╣Йр╕▓р╕бр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕ер╕Ър╕Ир╕гр╕┤р╕З р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕в');
      console.log('ЁЯТб р╣Гр╕Кр╣Й API endpoint /admin/check-bot-membership р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Чр╕Фр╕кр╕нр╕Ър╕Ир╕гр╕┤р╕З');
    } catch (error) {
      console.log('тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕ер╕Ър╕Зр╕▓р╕Щр╣Др╕Фр╣Й:', error.message);
    }

    console.log('\n5я╕ПтГг р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Бр╕ер╕░р╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф...');
    try {
      // р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕: р╣Др╕бр╣Ир╕Др╕зр╕гр╕гр╕▒р╕Щр╕Бр╕▓р╕гр╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╕Ир╕гр╕┤р╕Зр╣Гр╕Щр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ
      console.log('тЪая╕П  р╕Вр╣Йр╕▓р╕бр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╕Ир╕гр╕┤р╕З р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕в');
      console.log('ЁЯТб р╣Гр╕Кр╣Й API endpoint /admin/check-bot-membership р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Чр╕Фр╕кр╕нр╕Ър╕Ир╕гр╕┤р╕З');
    } catch (error) {
      console.log('тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╣Др╕Фр╣Й:', error.message);
    }

    console.log('\nЁЯУК р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ:');
    console.log('тЬЕ р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ');
    console.log('ЁЯТб р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╣Гр╕лр╕бр╣Ир╕Чр╕╡р╣Ир╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Вр╣Йр╕▓р╕бр╕▓:');
    console.log('   - checkBotMembershipInGroup(): р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Ыр╣Зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Вр╕нр╕З Bot');
    console.log('   - deleteAllTasksInGroup(): р╕ер╕Ър╕Зр╕▓р╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б');
    console.log('   - checkAndCleanupInactiveGroups(): р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Бр╕ер╕░р╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф');
    console.log('ЁЯТб Cron Job р╣Гр╕лр╕бр╣И: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Чр╕╕р╕Бр╕зр╕▒р╕Щр╣Ар╕зр╕ер╕▓ 10:00 р╕Щ.');
    console.log('ЁЯТб API Endpoint р╣Гр╕лр╕бр╣И: POST /admin/check-bot-membership');

  } catch (error) {
    console.error('тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ:', error);
  }
}

// р╕гр╕▒р╕Щр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ
if (require.main === module) {
  testBotMembershipCheck().catch(console.error);
}

module.exports = { testBotMembershipCheck };
